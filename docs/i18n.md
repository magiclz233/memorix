# 国际化方案（next-intl）实施说明

## 方案概览
本项目采用 **next-intl + Next.js App Router** 的本地化方案，核心思路：
- 使用 `app/[locale]/` 路由段驱动语言切换。
- `middleware` 自动识别语言并重写路由（默认 `zh-CN`）。
- 通过 `NextIntlClientProvider` 注入多语言 messages。
- 统一使用 `@/i18n/navigation` 中的 `Link/redirect/useRouter/usePathname` 以自动携带 locale。
- Server Actions 通过 `@/i18n/paths` 处理回调路径与 locale 前缀。
- 缓存刷新通过 `revalidatePathForAllLocales` 同步多语言页面。

## 关键文件
- 路由与配置
  - `i18n/routing.ts`：配置 `locales`、`defaultLocale`、`localePrefix`。
  - `i18n/request.ts`：加载 messages 并传入 next-intl。
  - `i18n/navigation.ts`：带 locale 的导航 API。
  - `middleware.ts`：语言检测与重写。
  - `app/[locale]/layout.tsx`：注入 `NextIntlClientProvider`、`ThemeProvider`。
  - `app/layout.tsx`：设置 `<html lang>`。
- 辅助工具
  - `i18n/paths.ts`：处理 locale 前缀的路径转换。
  - `app/lib/revalidate.ts`：多语言缓存刷新封装。
- 翻译资源
  - `messages/zh-CN.json`
  - `messages/en.json`

## 已完成（当前状态）
### 基础框架
- next-intl 已安装（`package.json`）。
- App Router 已完成 locale 路由分层（`app/[locale]/...`）。
- middleware 已生效（排除 `/api`、`/_next`、`/seed` 等）。
- 已提供语言切换组件 `components/locale-switcher.tsx`，并接入：
  - 前台顶部导航 `app/ui/front/floating-nav.tsx`
  - 登录/注册页 `app/[locale]/login/page.tsx`、`app/[locale]/signup/page.tsx`
  - 后台侧栏 `components/app-sidebar.tsx`

### 前台页面与组件
- 前台导航/页脚/首页/画廊/集合/关于页已接入翻译：
  - `app/ui/front/floating-nav.tsx`
  - `app/ui/front/front-footer.tsx`
  - `app/ui/front/front-home.tsx`
  - `app/ui/front/front-gallery.tsx`
  - `app/ui/front/gallery-filter.tsx`
  - `app/ui/front/gallery-infinite.tsx`
  - `app/ui/front/gallery-header.tsx`
  - `app/ui/front/media-card.tsx`
  - `app/ui/front/section-header.tsx`
  - `components/gallery25.tsx`
  - `app/[locale]/(front)/about/page.tsx`
  - `app/[locale]/(front)/photo-collections/page.tsx`
  - `app/[locale]/(front)/video-collections/page.tsx`
- 登录/注册相关已接入翻译：
  - `components/login-form.tsx`
  - `components/login-form-fields.tsx`
  - `components/github-signin-button.tsx`
  - `components/signup-form.tsx`
  - `app/[locale]/login/page.tsx`
  - `app/[locale]/signup/page.tsx`
- Gallery 详情弹窗与筛选已完成翻译（`components/gallery25.tsx`）。

### 路由与跳转
- `next/link` / `next/navigation` 已替换为 `@/i18n/navigation`（前台 & 后台关键链路）。
- Server Action 的 `redirect` 已替换为 `@/i18n/navigation`。
- `app/lib/actions.ts` 中的回调地址已做 locale 前缀处理（避免重复 locale）。
- `revalidatePath` 统一为 `revalidatePathForAllLocales`。

## 未完成（需要继续国际化）
### 管理后台页面
- `app/[locale]/dashboard/(overview)/page.tsx`
- `app/[locale]/dashboard/collections/page.tsx`
- `app/[locale]/dashboard/media/page.tsx`
- `app/[locale]/dashboard/storage/page.tsx`
- `app/[locale]/dashboard/upload/page.tsx`
- `app/[locale]/dashboard/settings/profile/page.tsx`
- `app/[locale]/dashboard/settings/system/page.tsx`
- `app/[locale]/dashboard/settings/users/page.tsx`
- `app/[locale]/dashboard/settings/users/user-actions.tsx`

### 管理后台组件（高优先级）
- `app/ui/admin/storage/storage-view.tsx`
- `app/ui/admin/storage/storage-modal.tsx`
- `app/ui/admin/storage/dependency-alert.tsx`
- `app/ui/admin/storage-config-form.tsx`
- `app/ui/admin/media/media-library.tsx`
- `components/app-sidebar.tsx`（菜单项标题仍为中文）

### 表单/弹窗与状态
- `app/ui/shared/change-password-form.tsx`
- `app/ui/dashboard/profile-form.tsx`
- `app/ui/dashboard/status-indicator.tsx`
- `components/theme-toggle.tsx`（aria-label）

### 后端返回/校验文案
- `app/lib/actions.ts` 中几乎所有错误/提示信息仍为中文。
- `app/api/storage/scan/route.ts` 错误提示。
- `app/lib/storage.ts` / `app/lib/storage-scan.ts` / `app/lib/data.ts` 日志与错误。

### 内容数据
- `app/lib/front-data.ts`：图集标题、描述、标签都是中文。
- `app/lib/media-data.ts`：媒体来源含中文。

> 说明：`schema.ts`、`utils.ts` 等主要是注释/日志，不一定需要 i18n，按需处理。

## 继续开发国际化的建议流程
1) **先补齐后台 UI 文案**
   - 给后台页面/组件加入 `useTranslations/getTranslations`。
   - 在 `messages/zh-CN.json` 与 `messages/en.json` 中添加对应 key。

2) **处理表单与弹窗**
   - 将 `Label`/`placeholder`/`Button`/`Dialog` 文案改成翻译 key。

3) **Server Actions 与 API 返回**
   - 方案 A：保持返回中文，仅前端提示前再翻译（简单）。
   - 方案 B：Server Action 按请求 locale 返回本地化文本（推荐长期方案）。
     - 可在 Action 中读取 `headers()` 或 `next-intl/server` 的 locale，再使用翻译 key。

4) **内容数据双语化**
   - 将 `front-data.ts` 的文案移入 messages，或按 locale 提供结构化数据。

## 新增语言步骤
1) **更新配置**
   - `i18n/routing.ts` 中加入新语言，例如 `ja`。

2) **新增翻译文件**
   - 新建 `messages/ja.json`，结构与 `messages/zh-CN.json` 一致。

3) **补齐 UI 文案**
   - 确保所有 `useTranslations/getTranslations` 的 key 在新语言中存在。

4) **更新语言切换器**
   - `components/locale-switcher.tsx` 目前仅显示 `中/EN`，需要新增新语言展示 label。

5) **验证**
   - 访问 `/ja`（或自动重定向）确认页面完整显示。
   - 检查日期格式（`toLocaleDateString`/`toLocaleString` 已按 locale）。

## 可选方案：不带语言前缀（根据用户设置自动切换）
> 说明：当前方案是“路径前缀”模式（`/zh-CN`、`/en`），SEO 与缓存友好。  
> 如果未来想改为“无前缀 + 用户偏好”，可参考以下思路（需改造）。

### 方案核心
- `localePrefix: "never"`（不再生成 `/zh-CN` / `/en` 路由）。
- 用户切换语言时写入 `NEXT_LOCALE`（或自定义）cookie。
- `middleware` 优先读取 cookie 或用户配置，决定当前 locale。

### 注意事项（权衡）
- 同一路径多语言会更偏向动态渲染，SSG/SEO 会弱一些。
- 缓存命中率会下降（同一 URL 需要区分语言缓存）。
- 需要保证 `middleware` 在所有入口路径生效。

### 伪代码示例（改造参考）
```ts
// middleware.ts（示例思路）
import createMiddleware from "next-intl/middleware";
import { routing } from "@/i18n/routing";

export default function middleware(req) {
  const preferred = req.cookies.get("NEXT_LOCALE")?.value;
  return createMiddleware({
    ...routing,
    localePrefix: "never",
    localeDetection: false,
    defaultLocale: preferred ?? routing.defaultLocale
  })(req);
}
```

```ts
// 用户切换语言时写 cookie（示例思路）
document.cookie = "NEXT_LOCALE=en; path=/; max-age=31536000";
```

### 推荐折中做法（如果暂不改造路由结构）
- 继续保持 `/zh-CN`、`/en` 前缀路由。
- 切换语言时写 cookie。
- middleware 对无前缀路径自动重定向到用户偏好语言前缀。

## 建议的分阶段完成路径
1) 先做后台 UI（Storage、Users、Settings）。
2) 再做表单/弹窗/状态类文案。
3) 最后做 Server Actions 与内容数据双语。

---
更新时间：2026-01-21
